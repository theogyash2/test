name: Setup and Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  setup-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: 35.154.127.150
          username: Administrator
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "=========================================="
            echo "Starting server setup and deployment..."
            echo "=========================================="
            
            # Check if Python installed
            echo ""
            echo "Checking Python..."
            if (Get-Command python -ErrorAction SilentlyContinue) {
              echo "‚úÖ Python already installed: $(python --version)"
            } else {
              echo "üì¶ Installing Python..."
              winget install Python.Python.3.13 -e --silent
              echo "‚úÖ Python installed"
            }
            
            # Check if Git installed
            echo ""
            echo "Checking Git..."
            if (Get-Command git -ErrorAction SilentlyContinue) {
              echo "‚úÖ Git already installed: $(git --version)"
            } else {
              echo "üì¶ Installing Git..."
              winget install Git.Git -e --silent
              echo "‚úÖ Git installed"
            }
            
            # Check if production folder exists
            echo ""
            echo "Checking production folder..."
            if (Test-Path C:\production) {
              echo "‚úÖ Production folder exists"
              echo "üì• Pulling latest code..."
              cd C:\production
              git pull origin main
            } else {
              echo "üì¶ Cloning repository..."
              git clone https://github.com/theogyash2/test.git C:\production
              cd C:\production
            }
            
            # Setup venv
            echo ""
            echo "Checking virtual environment..."
            if (Test-Path C:\production\venv) {
              echo "‚úÖ Virtual environment exists"
            } else {
              echo "üì¶ Creating virtual environment..."
              python -m venv venv
              echo "‚úÖ Virtual environment created"
            }
            
            # Install dependencies
            echo ""
            echo "üì¶ Installing Python dependencies..."
            .\venv\Scripts\pip.exe install -r requirements.txt --quiet
            echo "‚úÖ Dependencies installed"
            
            # Check database
            echo ""
            echo "Checking database..."
            if (Test-Path C:\production\database\ecommerce.db) {
              echo "‚úÖ Database exists"
            } else {
              echo "üì¶ Initializing database..."
              .\venv\Scripts\python.exe init_database.py
              echo "‚úÖ Database initialized"
            }
            
            # Check NSSM
            echo ""
            echo "Checking NSSM..."
            if (Test-Path C:\production\nssm) {
              echo "‚úÖ NSSM already installed"
            } else {
              echo "üì¶ Downloading NSSM..."
              Invoke-WebRequest -Uri "https://nssm.cc/release/nssm-2.24.zip" -OutFile "nssm.zip"
              Expand-Archive nssm.zip -DestinationPath .
              echo "‚úÖ NSSM installed"
            }
            
            # Check Nginx
            echo ""
            echo "Checking Nginx..."
            if (Test-Path C:\nginx) {
              echo "‚úÖ Nginx already installed"
            } else {
              echo "üì¶ Downloading Nginx..."
              Invoke-WebRequest -Uri "http://nginx.org/download/nginx-1.24.0.zip" -OutFile "nginx.zip"
              Expand-Archive nginx.zip -DestinationPath C:\
              Rename-Item C:\nginx-1.24.0 C:\nginx
              Copy-Item C:\production\nginx.conf C:\nginx\conf\nginx.conf
              echo "‚úÖ Nginx installed"
            }
            
            # Check UnicornMaster service
            echo ""
            echo "Checking UnicornMaster service..."
            $service = Get-Service UnicornMaster -ErrorAction SilentlyContinue
            if ($service) {
              echo "‚úÖ UnicornMaster service exists"
              echo "üîÑ Restarting UnicornMaster..."
              C:\production\nssm\nssm-2.24\win64\nssm.exe restart UnicornMaster
            } else {
              echo "üì¶ Installing UnicornMaster service..."
              C:\production\nssm\nssm-2.24\win64\nssm.exe install UnicornMaster "C:\production\venv\Scripts\python.exe" "C:\production\unicorn_master.py"
              C:\production\nssm\nssm-2.24\win64\nssm.exe set UnicornMaster AppDirectory "C:\production"
              C:\production\nssm\nssm-2.24\win64\nssm.exe set UnicornMaster Start SERVICE_AUTO_START
              C:\production\nssm\nssm-2.24\win64\nssm.exe start UnicornMaster
              echo "‚úÖ UnicornMaster service installed and started"
            }
            
            # Check Nginx service
            echo ""
            echo "Checking Nginx service..."
            $nginxService = Get-Service NginxService -ErrorAction SilentlyContinue
            if ($nginxService) {
              echo "‚úÖ Nginx service exists"
              echo "üîÑ Restarting Nginx..."
              C:\production\nssm\nssm-2.24\win64\nssm.exe restart NginxService
            } else {
              echo "üì¶ Installing Nginx service..."
              C:\production\nssm\nssm-2.24\win64\nssm.exe install NginxService "C:\nginx\nginx.exe"
              C:\production\nssm\nssm-2.24\win64\nssm.exe set NginxService AppDirectory "C:\nginx"
              C:\production\nssm\nssm-2.24\win64\nssm.exe set NginxService Start SERVICE_AUTO_START
              C:\production\nssm\nssm-2.24\win64\nssm.exe start NginxService
              echo "‚úÖ Nginx service installed and started"
            }
            
            # Check firewall rules
            echo ""
            echo "Checking firewall rules..."
            $httpRule = Get-NetFirewallRule -DisplayName "Allow HTTP Port 80" -ErrorAction SilentlyContinue
            if ($httpRule) {
              echo "‚úÖ HTTP firewall rule exists"
            } else {
              echo "üì¶ Adding HTTP firewall rule..."
              New-NetFirewallRule -DisplayName "Allow HTTP Port 80" -Direction Inbound -LocalPort 80 -Protocol TCP -Action Allow
              echo "‚úÖ HTTP firewall rule added"
            }
            
            echo ""
            echo "=========================================="
            echo "‚úÖ Setup and deployment complete!"
            echo "=========================================="
            echo "Waiting for services to start..."
            Start-Sleep -Seconds 15
      
      - name: Health check
        run: |
          echo "üè• Running health checks..."
          
          echo ""
          echo "Testing API root..."
          curl -f http://35.154.127.150/ || (echo "‚ùå API root failed" && exit 1)
          echo "‚úÖ API root OK"
          
          echo ""
          echo "Testing products endpoint..."
          response=$(curl -s http://35.154.127.150/api/products)
          if echo "$response" | grep -q "success"; then
            echo "‚úÖ Products endpoint OK"
          else
            echo "‚ùå Products endpoint failed"
            exit 1
          fi
          
          echo ""
          echo "=========================================="
          echo "‚úÖ ALL HEALTH CHECKS PASSED!"
          echo "=========================================="
          echo "üåê API: http://35.154.127.150"
          echo "üì¶ Products: http://35.154.127.150/api/products"
          echo "üìã Orders: http://35.154.127.150/api/orders"
          echo "üîê Auth: http://35.154.127.150/api/auth/login"
