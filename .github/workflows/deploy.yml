name: Deploy to Production via SSM

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  INSTANCE_ID: i-07fa5b29b2472d0fc
  AWS_REGION: ap-south-1
  SERVER_IP: 3.110.212.186

jobs:
  setup-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AK }}
          aws-secret-access-key: ${{ secrets.SAK }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Check and Install Python
        run: |
          echo "Checking Python..."
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ env.INSTANCE_ID }} \
            --document-name "AWS-RunPowerShellScript" \
            --parameters 'commands=["$pythonVersion = python --version 2>&1; if ($pythonVersion -match \"Python 3\") { Write-Host \"‚úÖ Python already installed: $pythonVersion\" } else { Write-Host \"üì¶ Installing Python...\"; winget install Python.Python.3.13 -e --silent --accept-source-agreements --accept-package-agreements; Write-Host \"‚úÖ Python installed\" }"]' \
            --output text \
            --query "Command.CommandId")
          
          sleep 30
          aws ssm get-command-invocation --instance-id ${{ env.INSTANCE_ID }} --command-id $COMMAND_ID --query "StandardOutputContent" --output text
      
      - name: Check and Install Git
        run: |
          echo "Checking Git..."
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ env.INSTANCE_ID }} \
            --document-name "AWS-RunPowerShellScript" \
            --parameters 'commands=["$gitVersion = git --version 2>&1; if ($gitVersion -match \"git version\") { Write-Host \"‚úÖ Git already installed: $gitVersion\" } else { Write-Host \"üì¶ Installing Git...\"; winget install Git.Git -e --silent --accept-source-agreements --accept-package-agreements; Write-Host \"‚úÖ Git installed\" }"]' \
            --output text \
            --query "Command.CommandId")
          
          sleep 30
          aws ssm get-command-invocation --instance-id ${{ env.INSTANCE_ID }} --command-id $COMMAND_ID --query "StandardOutputContent" --output text
      
      - name: Clone or Pull Repository
        run: |
          echo "Checking repository..."
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ env.INSTANCE_ID }} \
            --document-name "AWS-RunPowerShellScript" \
            --parameters 'commands=["if (Test-Path C:\\production\\.git) { Write-Host \"‚úÖ Repository exists, pulling latest...\"; cd C:\\production; git pull origin main; Write-Host \"‚úÖ Code updated\" } else { Write-Host \"üì¶ Cloning repository...\"; git clone https://github.com/theogyash2/test.git C:\\production; Write-Host \"‚úÖ Repository cloned\" }"]' \
            --output text \
            --query "Command.CommandId")
          
          sleep 20
          aws ssm get-command-invocation --instance-id ${{ env.INSTANCE_ID }} --command-id $COMMAND_ID --query "StandardOutputContent" --output text
      
      - name: Setup Virtual Environment
        run: |
          echo "Checking virtual environment..."
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ env.INSTANCE_ID }} \
            --document-name "AWS-RunPowerShellScript" \
            --parameters 'commands=["if (Test-Path C:\\production\\venv\\Scripts\\python.exe) { Write-Host \"‚úÖ Virtual environment exists\" } else { Write-Host \"üì¶ Creating virtual environment...\"; cd C:\\production; python -m venv venv; Write-Host \"‚úÖ Virtual environment created\" }"]' \
            --output text \
            --query "Command.CommandId")
          
          sleep 20
          aws ssm get-command-invocation --instance-id ${{ env.INSTANCE_ID }} --command-id $COMMAND_ID --query "StandardOutputContent" --output text
      
      - name: Install Dependencies
        run: |
          echo "Installing Python dependencies..."
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ env.INSTANCE_ID }} \
            --document-name "AWS-RunPowerShellScript" \
            --parameters 'commands=["Write-Host \"üì¶ Installing dependencies...\"; cd C:\\production; .\\venv\\Scripts\\pip.exe install --upgrade pip --quiet; .\\venv\\Scripts\\pip.exe install -r requirements.txt --quiet; Write-Host \"‚úÖ Dependencies installed\""]' \
            --output text \
            --query "Command.CommandId")
          
          sleep 45
          aws ssm get-command-invocation --instance-id ${{ env.INSTANCE_ID }} --command-id $COMMAND_ID --query "StandardOutputContent" --output text
      
      - name: Initialize Database
        run: |
          echo "Checking database..."
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ env.INSTANCE_ID }} \
            --document-name "AWS-RunPowerShellScript" \
            --parameters 'commands=["if (Test-Path C:\\production\\database\\ecommerce.db) { Write-Host \"‚úÖ Database exists\" } else { Write-Host \"üì¶ Initializing database...\"; cd C:\\production; .\\venv\\Scripts\\python.exe init_database.py; Write-Host \"‚úÖ Database initialized\" }"]' \
            --output text \
            --query "Command.CommandId")
          
          sleep 20
          aws ssm get-command-invocation --instance-id ${{ env.INSTANCE_ID }} --command-id $COMMAND_ID --query "StandardOutputContent" --output text
      
      - name: Check and Install NSSM
        run: |
          echo "Checking NSSM..."
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ env.INSTANCE_ID }} \
            --document-name "AWS-RunPowerShellScript" \
            --parameters 'commands=["if (Test-Path C:\\production\\nssm\\nssm-2.24\\win64\\nssm.exe) { Write-Host \"‚úÖ NSSM already installed\" } else { Write-Host \"üì¶ Downloading NSSM...\"; cd C:\\production; Invoke-WebRequest -Uri \"https://nssm.cc/release/nssm-2.24.zip\" -OutFile \"nssm.zip\"; Expand-Archive nssm.zip -Force; Write-Host \"‚úÖ NSSM installed\" }"]' \
            --output text \
            --query "Command.CommandId")
          
          sleep 30
          aws ssm get-command-invocation --instance-id ${{ env.INSTANCE_ID }} --command-id $COMMAND_ID --query "StandardOutputContent" --output text
      
      - name: Check and Install Nginx
        run: |
          echo "Checking Nginx..."
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ env.INSTANCE_ID }} \
            --document-name "AWS-RunPowerShellScript" \
            --parameters 'commands=["if (Test-Path C:\\nginx\\nginx.exe) { Write-Host \"‚úÖ Nginx already installed\"; Copy-Item C:\\production\\nginx.conf C:\\nginx\\conf\\nginx.conf -Force; Write-Host \"‚úÖ Nginx config updated\" } else { Write-Host \"üì¶ Downloading Nginx...\"; Invoke-WebRequest -Uri \"http://nginx.org/download/nginx-1.24.0.zip\" -OutFile \"C:\\nginx.zip\"; Expand-Archive C:\\nginx.zip -DestinationPath C:\\ -Force; Rename-Item C:\\nginx-1.24.0 C:\\nginx -Force; Copy-Item C:\\production\\nginx.conf C:\\nginx\\conf\\nginx.conf -Force; Write-Host \"‚úÖ Nginx installed\" }"]' \
            --output text \
            --query "Command.CommandId")
          
          sleep 30
          aws ssm get-command-invocation --instance-id ${{ env.INSTANCE_ID }} --command-id $COMMAND_ID --query "StandardOutputContent" --output text
      
      - name: Setup UnicornMaster Service
        run: |
          echo "Setting up UnicornMaster service..."
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ env.INSTANCE_ID }} \
            --document-name "AWS-RunPowerShellScript" \
            --parameters 'commands=["$service = Get-Service UnicornMaster -ErrorAction SilentlyContinue; if ($service) { Write-Host \"‚úÖ UnicornMaster service exists\"; Write-Host \"üîÑ Restarting UnicornMaster...\"; C:\\production\\nssm\\nssm-2.24\\win64\\nssm.exe restart UnicornMaster; Write-Host \"‚úÖ UnicornMaster restarted\" } else { Write-Host \"üì¶ Installing UnicornMaster service...\"; C:\\production\\nssm\\nssm-2.24\\win64\\nssm.exe install UnicornMaster \"C:\\production\\venv\\Scripts\\python.exe\" \"C:\\production\\unicorn_master.py\"; C:\\production\\nssm\\nssm-2.24\\win64\\nssm.exe set UnicornMaster AppDirectory \"C:\\production\"; C:\\production\\nssm\\nssm-2.24\\win64\\nssm.exe set UnicornMaster Start SERVICE_AUTO_START; C:\\production\\nssm\\nssm-2.24\\win64\\nssm.exe start UnicornMaster; Write-Host \"‚úÖ UnicornMaster service installed and started\" }"]' \
            --output text \
            --query "Command.CommandId")
          
          sleep 30
          aws ssm get-command-invocation --instance-id ${{ env.INSTANCE_ID }} --command-id $COMMAND_ID --query "StandardOutputContent" --output text
      
      - name: Setup Nginx Service
        run: |
          echo "Setting up Nginx service..."
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ env.INSTANCE_ID }} \
            --document-name "AWS-RunPowerShellScript" \
            --parameters 'commands=["$service = Get-Service NginxService -ErrorAction SilentlyContinue; if ($service) { Write-Host \"‚úÖ Nginx service exists\"; Write-Host \"üîÑ Restarting Nginx...\"; C:\\production\\nssm\\nssm-2.24\\win64\\nssm.exe restart NginxService; Write-Host \"‚úÖ Nginx restarted\" } else { Write-Host \"üì¶ Installing Nginx service...\"; C:\\production\\nssm\\nssm-2.24\\win64\\nssm.exe install NginxService \"C:\\nginx\\nginx.exe\"; C:\\production\\nssm\\nssm-2.24\\win64\\nssm.exe set NginxService AppDirectory \"C:\\nginx\"; C:\\production\\nssm\\nssm-2.24\\win64\\nssm.exe set NginxService Start SERVICE_AUTO_START; C:\\production\\nssm\\nssm-2.24\\win64\\nssm.exe start NginxService; Write-Host \"‚úÖ Nginx service installed and started\" }"]' \
            --output text \
            --query "Command.CommandId")
          
          sleep 30
          aws ssm get-command-invocation --instance-id ${{ env.INSTANCE_ID }} --command-id $COMMAND_ID --query "StandardOutputContent" --output text
      
      - name: Configure Firewall
        run: |
          echo "Configuring firewall..."
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ env.INSTANCE_ID }} \
            --document-name "AWS-RunPowerShellScript" \
            --parameters 'commands=["$rule = Get-NetFirewallRule -DisplayName \"Allow HTTP Port 80\" -ErrorAction SilentlyContinue; if ($rule) { Write-Host \"‚úÖ Firewall rule exists\" } else { Write-Host \"üì¶ Adding firewall rule...\"; New-NetFirewallRule -DisplayName \"Allow HTTP Port 80\" -Direction Inbound -LocalPort 80 -Protocol TCP -Action Allow; Write-Host \"‚úÖ Firewall rule added\" }"]' \
            --output text \
            --query "Command.CommandId")
          
          sleep 15
          aws ssm get-command-invocation --instance-id ${{ env.INSTANCE_ID }} --command-id $COMMAND_ID --query "StandardOutputContent" --output text
      
      - name: Verify Services Running
        run: |
          echo "Verifying services..."
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ env.INSTANCE_ID }} \
            --document-name "AWS-RunPowerShellScript" \
            --parameters 'commands=["Write-Host \"Checking services...\"; Get-Service UnicornMaster,NginxService | Format-Table Name,Status -AutoSize; Write-Host \"`nChecking ports...\"; netstat -ano | findstr \":80 :5001 :5002 :5011 :5012 :5021 :5022\""]' \
            --output text \
            --query "Command.CommandId")
          
          sleep 20
          aws ssm get-command-invocation --instance-id ${{ env.INSTANCE_ID }} --command-id $COMMAND_ID --query "StandardOutputContent" --output text
      
      - name: Wait for Services
        run: |
          echo "Waiting 30 seconds for services to fully start..."
          sleep 30
      
      - name: Health Check - API Root
        run: |
          echo "Testing API root..."
          response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ env.SERVER_IP }}/)
          if [ "$response" = "200" ]; then
            echo "‚úÖ API root OK (HTTP $response)"
          else
            echo "‚ùå API root failed (HTTP $response)"
            exit 1
          fi
      
      - name: Health Check - Products
        run: |
          echo "Testing products endpoint..."
          response=$(curl -s http://${{ env.SERVER_IP }}/api/products)
          if echo "$response" | grep -q "success"; then
            echo "‚úÖ Products endpoint OK"
            echo "$response" | head -c 200
          else
            echo "‚ùå Products endpoint failed"
            echo "$response"
            exit 1
          fi
      
      - name: Deployment Summary
        if: success()
        run: |
          echo ""
          echo "=========================================="
          echo "‚úÖ DEPLOYMENT SUCCESSFUL!"
          echo "=========================================="
          echo "üåê API: http://${{ env.SERVER_IP }}"
          echo "üì¶ Products: http://${{ env.SERVER_IP }}/api/products"
          echo "üìã Orders: http://${{ env.SERVER_IP }}/api/orders"
          echo "üîê Auth: http://${{ env.SERVER_IP }}/api/auth/login"
          echo "üß™ Test UI: http://${{ env.SERVER_IP }}/test"
          echo "=========================================="