name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: ap-south-1

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AK }}
          aws-secret-access-key: ${{ secrets.SAK }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Deploy to all instances
        run: |
          # Read instances
          INSTANCES=$(cat instances.json | jq -c '.instances[]')
          
          for instance in $INSTANCES; do
            NAME=$(echo $instance | jq -r '.name')
            ID=$(echo $instance | jq -r '.instance_id')
            IP=$(echo $instance | jq -r '.server_ip')
            
            echo "=========================================="
            echo "Deploying to $NAME ($IP)"
            echo "=========================================="
            
            # Check requirements
            MISSING=$(aws ssm send-command \
              --instance-ids "$ID" \
              --document-name "AWS-RunPowerShellScript" \
              --parameters 'commands=["
                $missing = @()
                if (!(Test-Path \"C:\\Python313\\python.exe\")) { $missing += \"python\" }
                if (!(Test-Path \"C:\\Program Files\\Git\\bin\\git.exe\")) { $missing += \"git\" }
                if (!(Test-Path \"C:\\production\\.git\")) { $missing += \"repo\" }
                if (!(Test-Path \"C:\\nssm\\nssm.exe\")) { $missing += \"nssm\" }
                if (!(Test-Path \"C:\\nginx\\nginx.exe\")) { $missing += \"nginx\" }
                if (!(Test-Path \"C:\\Redis\\redis-server.exe\")) { $missing += \"redis\" }
                if (!(Get-Service UnicornMaster -EA SilentlyContinue)) { $missing += \"unicorn\" }
                if (!(Get-Service NginxService -EA SilentlyContinue)) { $missing += \"nginxsvc\" }
                Write-Output ($missing -join \",\")
              "]' \
              --output text --query "Command.CommandId" --region $AWS_REGION)
            
            sleep 15
            RESULT=$(aws ssm get-command-invocation --instance-id "$ID" --command-id "$MISSING" --query "StandardOutputContent" --output text --region $AWS_REGION)
            
            if [ "$RESULT" != "" ]; then
              echo "[SETUP] Missing requirements: $RESULT"
              echo "[SETUP] Running full setup..."
              python3 setup_instance.py "$ID" "$RESULT"
            else
              echo "[OK] All requirements met"
            fi
            
            # Always: Update code and restart
            echo "[DEPLOY] Updating code..."
            aws ssm send-command \
              --instance-ids "$ID" \
              --document-name "AWS-RunPowerShellScript" \
              --parameters 'commands=["
                cd C:\\production
                & \"C:\\Program Files\\Git\\bin\\git.exe\" pull origin main
                & C:\\production\\venv\\Scripts\\pip.exe install -r requirements.txt -q
                & C:\\production\\venv\\Scripts\\pip.exe install --upgrade sqlalchemy flask-sqlalchemy -q
                Copy-Item C:\\production\\nginx.conf C:\\nginx\\conf\\nginx.conf -Force
                C:\\nssm\\nssm.exe restart UnicornMaster
                C:\\nssm\\nssm.exe restart NginxService
                Start-Sleep 10
                Write-Host \"[OK] Deployed to $NAME\"
              "]' \
              --region $AWS_REGION
            
            echo "[OK] Deployed to $NAME"
          done