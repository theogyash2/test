name: Deploy to Production via SSM

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  INSTANCE_ID: i-0bddff6ed7b3a173b
  AWS_REGION: ap-south-1
  SERVER_IP: 13.234.78.215

jobs:
  setup-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AK }}
          aws-secret-access-key: ${{ secrets.SAK }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Write SSM helper script
        run: |
          cat << 'EOF' > /tmp/ssm_run.sh
          #!/bin/bash
          INSTANCE_ID="$1"
          REGION="$2"
          COMMANDS="$3"
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunPowerShellScript" \
            --parameters "commands=[\"$COMMANDS\"]" \
            --output text --query "Command.CommandId" --region "$REGION")
          echo "SSM Command ID: $COMMAND_ID"
          for i in $(seq 1 36); do
            sleep 10
            STATUS=$(aws ssm get-command-invocation \
              --instance-id "$INSTANCE_ID" --command-id "$COMMAND_ID" \
              --query "Status" --output text --region "$REGION" 2>/dev/null)
            echo "Status: $STATUS"
            if [[ "$STATUS" == "Success" || "$STATUS" == "Failed" || "$STATUS" == "TimedOut" || "$STATUS" == "Cancelled" ]]; then
              break
            fi
          done
          STDOUT=$(aws ssm get-command-invocation --instance-id "$INSTANCE_ID" --command-id "$COMMAND_ID" --query "StandardOutputContent" --output text --region "$REGION")
          STDERR=$(aws ssm get-command-invocation --instance-id "$INSTANCE_ID" --command-id "$COMMAND_ID" --query "StandardErrorContent" --output text --region "$REGION")
          echo "=== STDOUT ===" && echo "$STDOUT"
          echo "=== STDERR ===" && echo "$STDERR"
          if [[ "$STATUS" != "Success" ]]; then echo "SSM command failed: $STATUS"; exit 1; fi
          EOF
          chmod +x /tmp/ssm_run.sh

      - name: Install Python
        run: |
          /tmp/ssm_run.sh "${{ env.INSTANCE_ID }}" "${{ env.AWS_REGION }}" \
          "\$ErrorActionPreference = 'Stop'; if (Test-Path 'C:\\Python313\\python.exe') { Write-Host '[OK] Python exists'; exit 0 }; Write-Host '[INSTALL] Installing Python...'; Invoke-WebRequest -Uri 'https://www.python.org/ftp/python/3.13.0/python-3.13.0-amd64.exe' -OutFile 'C:\\python_installer.exe'; Start-Process 'C:\\python_installer.exe' -ArgumentList '/quiet InstallAllUsers=1 PrependPath=1 TargetDir=C:\\Python313' -Wait; Write-Host '[OK] Python installed'"

      - name: Install Git
        run: |
          /tmp/ssm_run.sh "${{ env.INSTANCE_ID }}" "${{ env.AWS_REGION }}" \
          "\$ErrorActionPreference = 'Stop'; if (Test-Path 'C:\\Program Files\\Git\\bin\\git.exe') { Write-Host '‚úÖ Git exists'; exit 0 }; Write-Host 'üì¶ Installing Git...'; Invoke-WebRequest -Uri 'https://github.com/git-for-windows/git/releases/download/v2.47.1.windows.1/Git-2.47.1-64-bit.exe' -OutFile 'C:\\git_installer.exe'; Start-Process 'C:\\git_installer.exe' -ArgumentList '/VERYSILENT /NORESTART /NOCANCEL /SP-' -Wait; Write-Host '‚úÖ Git installed: ' + (& 'C:\\Program Files\\Git\\bin\\git.exe' --version 2>&1)"

      - name: Clone or Pull Repository
        run: |
          /tmp/ssm_run.sh "${{ env.INSTANCE_ID }}" "${{ env.AWS_REGION }}" \
          "\$ErrorActionPreference = 'Stop'; \$git = 'C:\\Program Files\\Git\\bin\\git.exe'; if (Test-Path 'C:\\production\\.git') { Write-Host '‚úÖ Repository exists, pulling...'; & \$git -C C:\\production pull origin main; Write-Host '‚úÖ Code updated' } else { Write-Host 'üì¶ Cloning repository...'; & \$git clone https://github.com/theogyash2/test.git C:\\production; Write-Host '‚úÖ Repository cloned' }"

      - name: Setup Virtual Environment
        run: |
          /tmp/ssm_run.sh "${{ env.INSTANCE_ID }}" "${{ env.AWS_REGION }}" \
          "\$ErrorActionPreference = 'Stop'; if (Test-Path 'C:\\production\\venv\\Scripts\\python.exe') { Write-Host '‚úÖ venv exists' } else { Write-Host 'üì¶ Creating venv...'; & 'C:\\Python313\\python.exe' -m venv C:\\production\\venv; Write-Host '‚úÖ venv created' }"

      - name: Install Dependencies
        run: |
          /tmp/ssm_run.sh "${{ env.INSTANCE_ID }}" "${{ env.AWS_REGION }}" \
          "\$ErrorActionPreference = 'Stop'; Write-Host 'üì¶ Installing dependencies...'; & 'C:\\production\\venv\\Scripts\\pip.exe' install --upgrade pip -q; & 'C:\\production\\venv\\Scripts\\pip.exe' install -r C:\\production\\requirements.txt -q; Write-Host '‚úÖ Dependencies installed'"
      - name: Upgrade SQLAlchemy
        run: |
          /tmp/ssm_run.sh "${{ env.INSTANCE_ID }}" "${{ env.AWS_REGION }}" \
          "\$ErrorActionPreference = 'Stop'; Write-Host '[INSTALL] Upgrading SQLAlchemy...'; & 'C:\\production\\venv\\Scripts\\pip.exe' install --upgrade sqlalchemy flask-sqlalchemy -q; Write-Host '[OK] SQLAlchemy upgraded'"
      
      - name: Initialize Database
        run: |
          /tmp/ssm_run.sh "${{ env.INSTANCE_ID }}" "${{ env.AWS_REGION }}" \
          "\$ErrorActionPreference = 'Stop'; if (Test-Path 'C:\\production\\database\\ecommerce.db') { Write-Host '‚úÖ DB exists' } else { Write-Host 'üì¶ Initializing database...'; & 'C:\\production\\venv\\Scripts\\python.exe' C:\\production\\init_database.py; Write-Host '‚úÖ DB initialized' }"

      - name: Copy NSSM from Repo
        run: |
          /tmp/ssm_run.sh "${{ env.INSTANCE_ID }}" "${{ env.AWS_REGION }}" \
          "\$ErrorActionPreference = 'Stop'; if (-not (Test-Path 'C:\\production\\tools\\nssm.exe')) { Write-Host '‚ùå ERROR: nssm.exe not found in repo tools folder!'; exit 1 }; if (-not (Test-Path 'C:\\nssm')) { New-Item -ItemType Directory -Path C:\\nssm -Force | Out-Null }; Copy-Item 'C:\\production\\tools\\nssm.exe' 'C:\\nssm\\nssm.exe' -Force; Write-Host '‚úÖ NSSM copied from repo'"

      - name: Install Nginx
        run: |
          /tmp/ssm_run.sh "${{ env.INSTANCE_ID }}" "${{ env.AWS_REGION }}" \
          "\$ErrorActionPreference = 'Stop'; if (-not (Test-Path 'C:\\nginx\\nginx.exe')) { Write-Host 'üì¶ Installing Nginx...'; Invoke-WebRequest -Uri 'http://nginx.org/download/nginx-1.24.0.zip' -OutFile 'C:\\nginx.zip'; Expand-Archive C:\\nginx.zip -DestinationPath C:\\ -Force; Rename-Item 'C:\\nginx-1.24.0' 'C:\\nginx' -Force; Write-Host '‚úÖ Nginx installed' } else { Write-Host '‚úÖ Nginx exists' }; if (-not (Test-Path 'C:\\production\\nginx.conf')) { Write-Host '‚ùå ERROR: nginx.conf not found in repo root!'; exit 1 }; Copy-Item 'C:\\production\\nginx.conf' 'C:\\nginx\\conf\\nginx.conf' -Force; Write-Host '‚úÖ nginx.conf copied and updated'"
      - name: Install Redis
        run: |
          /tmp/ssm_run.sh "${{ env.INSTANCE_ID }}" "${{ env.AWS_REGION }}" \
          "\$ErrorActionPreference = 'Continue'; if (-not (Test-Path 'C:\\Redis\\redis-server.exe')) { Write-Host '[INSTALL] Installing Redis...'; try { Invoke-WebRequest -Uri 'https://github.com/tporadowski/redis/releases/download/v5.0.14.1/Redis-x64-5.0.14.1.zip' -OutFile 'C:\\redis.zip' -UseBasicParsing; Expand-Archive C:\\redis.zip -DestinationPath C:\\ -Force; if (Test-Path 'C:\\Redis-x64-5.0.14.1') { Rename-Item 'C:\\Redis-x64-5.0.14.1' 'C:\\Redis' -Force -ErrorAction SilentlyContinue }; Write-Host '[OK] Redis installed' } catch { Write-Host '[ERROR] Redis install failed: ' + \$_.Exception.Message; exit 1 } } else { Write-Host '[OK] Redis exists' }"
      
      - name: Setup Redis Service
        run: |
          /tmp/ssm_run.sh "${{ env.INSTANCE_ID }}" "${{ env.AWS_REGION }}" \
          "\$ErrorActionPreference = 'Continue'; \$nssm = 'C:\\nssm\\nssm.exe'; \$svc = Get-Service RedisService -ErrorAction SilentlyContinue; if (\$svc) { Write-Host '[RESTART] Restarting Redis...'; & \$nssm restart RedisService; Start-Sleep 3 } else { Write-Host '[INSTALL] Installing Redis service...'; & \$nssm install RedisService 'C:\\Redis\\redis-server.exe' 'C:\\Redis\\redis.windows.conf'; & \$nssm set RedisService AppDirectory 'C:\\Redis'; & \$nssm set RedisService Start SERVICE_AUTO_START; Start-Sleep 2; & \$nssm start RedisService; Start-Sleep 3; Write-Host '[OK] Redis installed' }; \$status = Get-Service RedisService; Write-Host '[STATUS]' \$status.Status"
      - name: Setup UnicornMaster Service
        run: |
          /tmp/ssm_run.sh "${{ env.INSTANCE_ID }}" "${{ env.AWS_REGION }}" \
          "\$ErrorActionPreference = 'Stop'; \$nssm = 'C:\\nssm\\nssm.exe'; \$svc = Get-Service UnicornMaster -ErrorAction SilentlyContinue; if (\$svc) { Write-Host 'üîÑ Restarting UnicornMaster...'; & \$nssm restart UnicornMaster; Write-Host '‚úÖ UnicornMaster restarted' } else { Write-Host 'üì¶ Installing UnicornMaster service...'; & \$nssm install UnicornMaster 'C:\\production\\venv\\Scripts\\python.exe' 'C:\\production\\unicorn_master.py'; & \$nssm set UnicornMaster AppDirectory 'C:\\production'; & \$nssm set UnicornMaster Start SERVICE_AUTO_START; & \$nssm start UnicornMaster; Write-Host '‚úÖ UnicornMaster installed' }; Start-Sleep 5; \$s = Get-Service UnicornMaster; if (\$s.Status -ne 'Running') { Write-Host '‚ùå UnicornMaster not running: ' + \$s.Status; exit 1 }; Write-Host '‚úÖ UnicornMaster running'"

      - name: Setup Nginx Service
        run: |
          /tmp/ssm_run.sh "${{ env.INSTANCE_ID }}" "${{ env.AWS_REGION }}" \
          "\$ErrorActionPreference = 'Stop'; \$nssm = 'C:\\nssm\\nssm.exe'; \$svc = Get-Service NginxService -ErrorAction SilentlyContinue; if (\$svc) { Write-Host 'üîÑ Restarting NginxService...'; & \$nssm restart NginxService; Write-Host '‚úÖ NginxService restarted' } else { Write-Host 'üì¶ Installing Nginx service...'; & \$nssm install NginxService 'C:\\nginx\\nginx.exe'; & \$nssm set NginxService AppDirectory 'C:\\nginx'; & \$nssm set NginxService Start SERVICE_AUTO_START; & \$nssm start NginxService; Write-Host '‚úÖ NginxService installed' }; Start-Sleep 5; \$s = Get-Service NginxService; if (\$s.Status -ne 'Running') { Write-Host '‚ùå NginxService not running: ' + \$s.Status; exit 1 }; Write-Host '‚úÖ NginxService running'"

      - name: Configure Firewall
        run: |
          /tmp/ssm_run.sh "${{ env.INSTANCE_ID }}" "${{ env.AWS_REGION }}" \
          "\$rule = Get-NetFirewallRule -DisplayName 'Allow HTTP Port 80' -ErrorAction SilentlyContinue; if (-not \$rule) { Write-Host 'üì¶ Adding firewall rule...'; New-NetFirewallRule -DisplayName 'Allow HTTP Port 80' -Direction Inbound -LocalPort 80 -Protocol TCP -Action Allow; Write-Host '‚úÖ Firewall rule added' } else { Write-Host '‚úÖ Firewall rule exists' }"

      - name: Verify Port 80 Listening
        run: |
          /tmp/ssm_run.sh "${{ env.INSTANCE_ID }}" "${{ env.AWS_REGION }}" \
          "\$listening = netstat -ano | findstr 'LISTENING' | findstr ':80 '; if (-not \$listening) { Write-Host '‚ùå Port 80 not listening'; exit 1 }; Write-Host '‚úÖ Port 80 is listening'"

      - name: Health Check with Retry
        run: |
          echo "Polling http://${{ env.SERVER_IP }} ..."
          for i in {1..12}; do
            echo "Attempt $i/12..."
            response=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 --max-time 15 http://${{ env.SERVER_IP }}/)
            if [ "$response" = "200" ]; then echo " API is up! (HTTP $response)"; exit 0; fi
            echo "HTTP $response - retrying in 10s..."
            sleep 10
          done
          echo " Service did not respond after 2 minutes"; exit 1

      - name: Health Check - Products
        run: |
          response=$(curl -s http://${{ env.SERVER_IP }}/api/products)
          if echo "$response" | grep -q "success"; then echo " Products OK"; else echo "‚ùå Products failed: $response"; exit 1; fi

      - name: Deployment Summary
        if: success()
        run: |
          echo ""
          echo "=========================================="
          echo " DEPLOYMENT SUCCESSFUL!"
          echo "=========================================="
          echo "üåê API: http://${{ env.SERVER_IP }}"
          echo "üì¶ Products: http://${{ env.SERVER_IP }}/api/products"
          echo "üìã Orders: http://${{ env.SERVER_IP }}/api/orders"
          echo "üîê Auth: http://${{ env.SERVER_IP }}/api/auth/login"
          echo "=========================================="
