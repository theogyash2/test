name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # ← Enables manual trigger button

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Trigger deployment via webhook
        run: |
          curl -X POST http://13.232.50.25:9000/deploy \
            -H "Content-Type: application/json" \
            -d '{"ref":"refs/heads/main","repository":{"name":"test"}}'
      
      - name: Wait for deployment
        run: sleep 20
      
      - name: Health check
        run: |
          response=$(curl -s http://13.232.50.25/api/products)
          if echo "$response" | grep -q "success"; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Health check failed"
            exit 1
          fi